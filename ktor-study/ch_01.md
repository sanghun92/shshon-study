# 1장. 근접성 서비스
- 근접성 서비스는 주변 아파트 시세, 음식점 등 현재 위치에서 가까운 시설을 찾는데 도움을 주는 서비스이다.
- 네이버 부동산의 경우 주변 아파트 시세를 조회할수 있고, 배달의 민족의 경우 집근처 원하는 음식점을 검색, 주문 등의 기능 구현에 이용된다.
---

## 문제 정의
- 사용자의 위치와 검색 반경 정보에 매치되는 사업장 목록을 반환
- 사업장 소유주가 사업장 정보를 추가 / 삭제 / 갱신할 수 있다.
  - 변경 된 정보는 최대 다음날까지 반영되어야 한다.
- 고객은 사업장의 상세 정보를 조회할 수 있어야 한다.
---

## 비기능 요구사항
- 낮은 응답 지연: 사용자는 주변 사업장을 신속히 검색할 수 있어야 한다.
- 데이터 보호 : 사용자 정보와 같은 민감 정보를 보호할 방법을 고려해야 한다.
- 고가용성, 규모 확장성 : 트래픽이 급증해도 감당할 수 있어야 한다.

---

## 개략적 규모 추정
- DAU : 1억명
- 한 사용자는 하루에 5회 검색을 시도한다고 가정
  - QPS : (1억 * 5) / 24 / 3600 = 약 5,400
  - 최대 QPS : 2 * 5400 = 10,800
- 등록 된 사업장 수 : 2억

---
## 데이터 모델
- Read/Write 비율
  - 빈도수 : Read > Write
    - 주변 사업장 검색, 사업장 정보 확인 요청의 이용 빈도가 높다.
    - 반면 사업장 정보를 추가 / 삭제 / 수정하는 요청은 별로 없다.

---
## 주변 사업장 검색 알고리즘
- 대다수가 '레디스 지오해시' or 'PostGIS'를 사용한다.
- 지리 정보 색인 알고리즘
  - 해시 기반
    - 균등 격자
    - 지오해시
    - 카르테시안 계층 등
  - 트리 기반
    - 쿼드트리
    - 구글 S2,
    - R 트리 등
  - 해당 알고리즘들은 "지도를 작은 영역으로 분할하고 고속 검색이 가능하도록 색인을 만드는데" 초첨을 둔다.

- 균등 격자
  - 지도를 작은 격자 or 구획으로 나누는 방법이다.
  - 단점 : 사업장 분포가 균등하지 않다. 즉 한 격자에 많은 사업장이 몰릴 수 있다.
  - Solution : 인구 밀집도가 높은 곳은 작은 격자를, 그렇지 않은 지역은 큰 격자를 사용한다.

- 지오해시
  - 전 세계를 자오선과 적도 기준 사분면으로 나눔.
  - 재귀적으로 원하는 정밀도를 얻을때까지 사분면으로 분할.
    - 위도 [-90, 0] -> 0에 대응
    - 위도 [0, 90] -> 1에 대응
    - 위도 [-180, 0] -> 0에 대응
    - 위도 [0, 180] -> 1에 대응
  - 위도 경도값을 Hash하여 일정한 영문자 및 숫자값으로 치환해준다.
  - Base32 표현법 사용
    - e.g) 1001 11010 01001 10001 11111 11110 -> 9q9hvu
  - 격자 가장자리 이슈
    - 지오해시는 해시값의 prefix가 긴 격자들이 서로 더 가깝게 놓이도록 보장함.
    - 하지만 그 역은 참이 아님. 가령 가까운 두 위치가 적도의 다른 쪽에 놓이거나, 지오선상의 다른 반쪽에 놓이는 경우 prefix가 다름.
    - 이 이슈때문에 단순한 접두어 기반 SQL을 사용하면 주변 사업장을 모두 가져올 수 없음.
    - 또 다른 이슈는 두 지점이 prefix 길이는 길지만 서로 다른 격자에 놓이는 경우
    - 해결책으로는 현재 격자외 인접한 모든 격자의 사업장 정보를 가져오는것.

- 쿼드트리
  - 격자의 내용이 특정 기준을 만족할 때까지 2차원 공간을 재귀적으로 사분면 분할함.
  - 메모리 사용량을 계산할려면 어떤 데이터가 보관되는지 정의해야 함.
    - 말단 노드 : 식별 용도로 사용되는 좌상단과 우하단 좌표, 격자내 사업장 ID 목록
    - 내부 노드 : 식별 용도로 사용되는 좌상단과 우하단 좌표, 하위 노드 포인터(4개)
    - 격자내 최대 100개 사업장
    - 말단 노드의 수 = ~ 200m/100 = ~2m
    - 내부 노드의 수 = 2m * 1/3 = ~0.67m
    - 메모리 요구량 = 2m * 832byte + 0.67m * 64byte = ~1.71GB
  - 전체 쿼드트리 구축 소요 시간 : n/100 log n/100
  - 서버 구동시 트리를 구축하는데 많은 시간이 소요됨.
    - 이 시간동안 트래픽 처리 불가
  - 따라서 한번에 너무 많은 서버를 동시 배포하지 않고, 점진적으로 배포해야함.

- 지오해시 vs 쿼드트리
  - 지오해시
    - 구현 및 사용이 쉬움. 트리 구축 x
    - 지정 반경내 사업장 검색 지원
    - 정밀도를 고정하면 격자 크기도 고정됨. 따라서 인구 밀도에 따라 동적으로 격자 크기 조정이 불가능함.
    - 색인 갱신이 쉬움.
  - 쿼드트리
    - 트리를 구성해야하기 때문에 구현을 더 어려움.
    - k번째로 인접한 사업장 목록을 구할 수 있음.
    - 인구 밀도에 따라 격자 크기를 동적으로 조정 가능.
    - 색인 갱신이 까다로움.
---

## 상세 설계
- 데이터베이스 규모 확장성
  - 사업장 테이블
    - 샤딩하기 좋은 후보.
  - 지리 정보 색인 테이블
    - 지오해시 : 각각의 지오해시에 연결 된 사업장 ID를 JSON 형태로 저장
    - 각 사업장별 지오해시 정보를 저장
    - 샤딩은 application layer에서 구현해야하기 때문에 적합하지 않음.
- 캐시
  - Read 연산 중심, DB 크기가 작음.
  - 따라서 메모리 캐시를 사용했을때와 성능이 비슷하여 캐시 도입이 꼭 필요한지 의문.

- 캐시 데이터 유형
  - (지오해시, 해당 격자내 사업장 ID 목록)
  - (사업장 ID, 사업장 정보)

- 지역 및 가용성 구역
  - 지역별 데이터 센터 사용
    - 미국 사용자는 미국 데이터 센터로 연결
    - 유럽 사용자는 유럽 데이터 센터로 연결
  - 트래픽을 인구에 따라 고르게 분산
---

## 마무리
- 가장 많이 쓰이는 기술은 지오해시, 쿼드트리, S2임
