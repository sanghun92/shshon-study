# 2장. 주변 친구
- 주변 친구 서비스는 인근의 친구 목록을 보여주는 서비스임.
- 사업장 주소는 정적이지만, 주변 친구 위치는 자주 바뀜.
---

## 비기능 요구사항
- 낮은 지연 시간 : 주변 친구의 위치 변화는 빠르게 반영되어야 함.
- 안정성 : 몇개 데이터는 유실 허용.
- 결과적 일관성 : 강한 일관성(strong consistency)일 필요 없음.

---

## 개략적 규모 추정
- 주변 친구는 8km 반경 이내로 제한.
  - 30초 주기로 갱신.
- DAU : 1천만명
- 한 사용자는 400명의 친구를 가짐.
    - QPS : 천만 / 30 = 약 334,000

---
## API 설계
- 

## 데이터 모델
- 위치 정보 캐시
  - '주변 친구' 기능을 활성화한 친구의 최근 위치 정보 저장
    - Key/Value : 사용자 ID | {위도, 경도, 시각}
    - 사용자의 현재 위치만 필요하고, 영속성 보장이 필요없기 때문에 RDB를 사용하지 않음.
- 위치 이동 이력 데이터배이스
  - user_id | latitude | longiude | timestamp 저장
  - write 연산이 많으며, scale-up이 가능해야하므로 카산드라가 적합.

---
## 규모 확장성
- API 서버 : Stateless하기 때문에 scale-out 하기 쉽다.
- 웹소켓 서버 : 웹소켓 서버 또한 scale-out하기 용이하다. 그렇지만 기존 서버를 제거할때는 주의해야한다.
  - 노드 제거시 : 기존 연결부터 종료, 노드 상태를 연결 종료중 으로 변경
- 레디스 펍/섭 서버 : 레디스 펍/섭 채널은 비용이 저렴하다.
  - 채널 하나를 유지할때 hash table, linked list를 필요로하는데 소량의 메모리만 사용함.
---
